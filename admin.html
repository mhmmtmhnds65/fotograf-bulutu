<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Panel V5 (Final)</title>
    <style>
        body { font-family: sans-serif; background: #eee; padding: 10px; }
        .box { background: white; padding: 15px; border-radius: 10px; max-width: 400px; margin: 0 auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-top: 0; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 5px; }
        input[type="file"] { background: #f0f0f0; padding: 15px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 5px; color: white; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 5px; margin-bottom: 5px; }
        .btn-green { background-color: #28a745; }
        .btn-red { background-color: #dc3545; }
        .btn-gray { background-color: #6c757d; }
        #console { background: #000; color: #0f0; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 11px; height: 250px; overflow-y: auto; margin-top: 15px; }
        .log-err { color: #ff5555; }
        .log-warn { color: #ffaa00; }
        .log-info { color: #00ccff; }
    </style>
</head>
<body>

<div class="box">
    <h2>ğŸ›ï¸ Panel V5 (Final)</h2>
    
    <label>GitHub Token:</label>
    <input type="password" id="token" placeholder="ghp_...">
    
    <label>Repo AdÄ±:</label>
    <input type="text" id="repo" value="mhmmtmhnds65/fotograf-bulutu">
    
    <hr>
    
    <h3>ğŸ“¤ FotoÄŸraf YÃ¼kle</h3>
    <input type="file" id="fileInput" multiple accept="image/*">
    <button class="btn btn-green" onclick="yuklemeyiBaslat()">ğŸš€ YÃœKLEMEYÄ° BAÅLAT</button>
    
    <hr>
    
    <h3>ğŸ—‘ï¸ Temizlik (Format)</h3>
    <button class="btn btn-red" onclick="temizligiBaslat()">âš ï¸ TÃœM RESÄ°MLERÄ° SÄ°L (SIFIRLA)</button>
    
    <button class="btn btn-gray" onclick="location.reload()">ğŸ”„ Paneli Yenile</button>
    
    <div id="console">HazÄ±r...</div>
</div>

<script>
    window.onerror = function(msg, url, line) { log(`SÄ°STEM HATASI: ${msg}`, 'err'); return false; };
    const savedToken = localStorage.getItem("gh_token");
    if(savedToken) document.getElementById("token").value = savedToken;
    const uyku = (ms) => new Promise(r => setTimeout(r, ms));

    function log(msg, type='') {
        const c = document.getElementById("console");
        const span = document.createElement("div");
        if(type === 'err') span.className = 'log-err';
        if(type === 'warn') span.className = 'log-warn';
        if(type === 'info') span.className = 'log-info';
        span.innerText = "> " + msg;
        c.prepend(span);
    }

    // --- YÃœKLEME FONKSÄ°YONLARI ---
    async function yuklemeyiBaslat() {
        const files = document.getElementById('fileInput').files;
        const token = document.getElementById("token").value.trim();
        const repo = document.getElementById("repo").value.trim();
        
        if (!token) { log("HATA: Token girin!", 'err'); return; }
        if (files.length === 0) { log("UYARI: Dosya seÃ§mediniz!", 'warn'); return; }
        localStorage.setItem("gh_token", token);

        try {
            let index = 0; let shaIndex = null;
            log("BaÄŸlanÄ±lÄ±yor...");
            // Index al
            try {
                const resp = await fetch(`https://api.github.com/repos/${repo}/contents/index.txt`, { headers: { "Authorization": `token ${token}` } });
                if (resp.ok) { const data = await resp.json(); index = parseInt(atob(data.content)); shaIndex = data.sha; log(`Mevcut Resim SayÄ±sÄ±: ${index}`); }
            } catch (e) {}

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                log(`[${i+1}/${files.length}] YÃ¼kleniyor: ${file.name}...`);
                try {
                    const bmpData = await processImage(file);
                    index++;
                    const filename = `test${index}.bmp`;
                    
                    const put = await fetch(`https://api.github.com/repos/${repo}/contents/${filename}`, {
                        method: "PUT", headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                        body: JSON.stringify({ message: "V5 Upload", content: arrayBufferToBase64(bmpData) })
                    });
                    
                    if(put.ok) log(`âœ… ${filename} Tamam!`, 'info');
                    else { log(`âŒ Hata: ${put.status}`, 'err'); index--; }
                    
                    if (i < files.length - 1) await uyku(1000); // 1 sn bekle
                } catch (e) { log(`Hata: ${e.message}`, 'err'); index--; }
            }
            // Index gÃ¼ncelle
            const body = { message: "Index update", content: btoa(index.toString()) };
            if (shaIndex) body.sha = shaIndex;
            await fetch(`https://api.github.com/repos/${repo}/contents/index.txt`, { method: "PUT", headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" }, body: JSON.stringify(body) });
            log("ğŸ‰ YÃœKLEME BÄ°TTÄ°!", 'info');
        } catch (e) { log(`Genel Hata: ${e.message}`, 'err'); }
    }

    // --- SÄ°LME (TEMÄ°ZLÄ°K) FONKSÄ°YONLARI ---
    async function temizligiBaslat() {
        if(!confirm("EMÄ°N MÄ°SÄ°N? BÃ¼tÃ¼n 'test.bmp' resimleri silinecek ve sayaÃ§ sÄ±fÄ±rlanacak!")) return;
        
        const token = document.getElementById("token").value.trim();
        const repo = document.getElementById("repo").value.trim();
        if (!token) { log("HATA: Token girin!", 'err'); return; }
        localStorage.setItem("gh_token", token);

        log("ğŸ§¹ Temizlik BaÅŸlÄ±yor... Dosyalar listeleniyor...", 'warn');

        try {
            // 1. Dosya Listesini Ã‡ek
            const resp = await fetch(`https://api.github.com/repos/${repo}/contents/`, { headers: { "Authorization": `token ${token}` } });
            if (!resp.ok) throw new Error("Dosya listesi alÄ±namadÄ±!");
            
            const dosyalar = await resp.json();
            // Sadece testX.bmp olanlarÄ± filtrele
            const silinecekler = dosyalar.filter(d => d.name.startsWith("test") && d.name.endsWith(".bmp"));
            
            if (silinecekler.length === 0) { log("Silinecek resim bulunamadÄ±.", 'info'); return; }

            log(`ğŸ—‘ï¸ Toplam ${silinecekler.length} resim silinecek. BaÅŸlÄ±yor...`, 'warn');

            // 2. Tek Tek Sil
            for (let i = 0; i < silinecekler.length; i++) {
                const dosya = silinecekler[i];
                log(`[${i+1}/${silinecekler.length}] Siliniyor: ${dosya.name}...`);
                
                const delResp = await fetch(`https://api.github.com/repos/${repo}/contents/${dosya.name}`, {
                    method: "DELETE",
                    headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "V5 Toplu Silme", sha: dosya.sha })
                });

                if(delResp.ok) log(`âœ… ${dosya.name} Silindi.`);
                else log(`âŒ ${dosya.name} Silinemedi!`, 'err');
                
                await uyku(800); // GitHub kÄ±zmasÄ±n diye hafif bekleme
            }

            // 3. Index DosyasÄ±nÄ± SÄ±fÄ±rla
            log("ğŸ”„ SayaÃ§ (index.txt) sÄ±fÄ±rlanÄ±yor...");
            // Index'in SHA'sÄ±nÄ± bul
            const indexFile = dosyalar.find(d => d.name === "index.txt");
            const resetBody = { message: "Index Sifirlandi", content: btoa("0") }; // 0 YazÄ±yoruz
            if (indexFile) resetBody.sha = indexFile.sha;
            
            await fetch(`https://api.github.com/repos/${repo}/contents/index.txt`, {
                 method: "PUT", headers: { "Authorization": `token ${token}`, "Content-Type": "application/json" },
                 body: JSON.stringify(resetBody)
            });

            log("âœ¨ PIRIL PIRIL OLDU! Her ÅŸey sÄ±fÄ±rlandÄ±.", 'info');

        } catch (e) { log(`HATA: ${e.message}`, 'err'); }
    }

    // --- YARDIMCI FONKSÄ°YONLAR ---
    function processImage(file) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement("canvas"); canvas.width = 240; canvas.height = 240;
                const ctx = canvas.getContext("2d");
                const min = Math.min(img.width, img.height);
                ctx.drawImage(img, (img.width-min)/2, (img.height-min)/2, min, min, 0, 0, 240, 240);
                resolve(encodeBMP(ctx.getImageData(0,0,240,240)));
            };
            img.onerror = () => reject(new Error("Resim HatasÄ±")); img.src = URL.createObjectURL(file);
        });
    }
    function encodeBMP(imgData) {
        const w = 240, h = 240; const fileSize = 54 + (w*3*h); const buf = new ArrayBuffer(fileSize); const view = new DataView(buf);
        view.setUint8(0, 0x42); view.setUint8(1, 0x4D); view.setUint32(2, fileSize, true); view.setUint32(10, 54, true); view.setUint32(14, 40, true);
        view.setInt32(18, w, true); view.setInt32(22, h, true); view.setUint16(26, 1, true); view.setUint16(28, 24, true);
        let p = 54;
        for (let y = h - 1; y >= 0; y--) {
            for (let x = 0; x < w; x++) {
                const i = (y * w + x) * 4;
                view.setUint8(p++, imgData.data[i+2]); view.setUint8(p++, imgData.data[i+1]); view.setUint8(p++, imgData.data[i]);
            }
        }
        return buf;
    }
    function arrayBufferToBase64(buffer) {
        let binary = ''; const bytes = new Uint8Array(buffer);
        for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
        return window.btoa(binary);
    }
</script>
</body>
</html>